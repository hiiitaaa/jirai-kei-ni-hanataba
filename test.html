<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°é›·å¨˜ã«èŠ±æŸã‚’ - çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,105,180,0.2);
            border-radius: 10px;
        }

        .test-section {
            background: rgba(0,0,0,0.5);
            border: 1px solid #ff69b4;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-title {
            color: #ff69b4;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .test-button {
            background: #ff69b4;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        .test-button:hover {
            background: #ff1493;
        }

        .console-output {
            background: #000;
            border: 1px solid #444;
            padding: 10px;
            margin-top: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .console-line {
            margin: 2px 0;
        }

        .console-error {
            color: #ff4444;
        }

        .console-success {
            color: #44ff44;
        }

        .console-info {
            color: #4444ff;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-ok {
            background: #0f0;
        }

        .status-error {
            background: #f00;
        }

        .status-loading {
            background: #ff0;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .system-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            background: rgba(50,50,50,0.5);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ® åœ°é›·å¨˜ã«èŠ±æŸã‚’ - ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
            <p>å…¨ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèªã¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</p>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            <div class="system-status" id="systemStatus">
                <div class="status-item">
                    <span class="status-indicator status-loading" id="csvStatus"></span>
                    <span>CSV Loader</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-loading" id="triggerStatus"></span>
                    <span>Trigger System</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-loading" id="novelStatus"></span>
                    <span>Novel System</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-loading" id="videoStatus"></span>
                    <span>Video Manager</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator status-loading" id="mainStatus"></span>
                    <span>Main System</span>
                </div>
            </div>
        </div>

        <!-- CSVèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ“ CSVãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testCSVLoader()">CSVãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="loadStoryData()">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
            <button class="test-button" onclick="loadTriggerData()">ãƒˆãƒªã‚¬ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
            <button class="test-button" onclick="clearCSVCache()">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
        </div>

        <!-- ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2 class="test-title">âš¡ ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="initTriggerSystem()">ãƒˆãƒªã‚¬ãƒ¼åˆæœŸåŒ–</button>
            <button class="test-button" onclick="testTriggerCheck()">ãƒˆãƒªã‚¬ãƒ¼ãƒã‚§ãƒƒã‚¯</button>
            <button class="test-button" onclick="debugTriggers()">ãƒˆãƒªã‚¬ãƒ¼ä¸€è¦§</button>
        </div>

        <!-- ãƒãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ“– ãƒãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testNovelSystem('prologue')">ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°é–‹å§‹</button>
            <button class="test-button" onclick="testNovelSystem('meeting')">å¾…ã¡åˆã‚ã›ã‚·ãƒ¼ãƒ³</button>
            <button class="test-button" onclick="testNovelSystem('dinner_scene')">é£Ÿäº‹ã‚·ãƒ¼ãƒ³</button>
            <button class="test-button" onclick="testNovelSystem('home_scene')">è‡ªå®…ã‚·ãƒ¼ãƒ³</button>
            <button class="test-button" onclick="debugNovelStatus()">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</button>
        </div>

        <!-- ãƒ“ãƒ‡ã‚ªãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ¬ ãƒ“ãƒ‡ã‚ªãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testVideo('easy_reward_intro')">EASYå‹•ç”»ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testVideo('normal_reward_intro')">NORMALå‹•ç”»ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testVideo('hard_reward_intro')">HARDå‹•ç”»ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="debugVideoStatus()">å‹•ç”»ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ® ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testMainSystem()">ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</button>
            <button class="test-button" onclick="testStartGame()">æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button class="test-button" onclick="testSaveLoad()">ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰</button>
            <button class="test-button" onclick="resetGame()">ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ› -->
        <div class="test-section">
            <h2 class="test-title">ğŸ“ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
            <button class="test-button" onclick="clearConsole()">ã‚¯ãƒªã‚¢</button>
            <div class="console-output" id="consoleOutput"></div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆæœ¬ç•ªã¨åŒã˜é †åºï¼‰ -->
    <script src="js/csv_loader.js"></script>
    <script src="js/trigger_system.js"></script>
    <script src="js/novel.js"></script>
    <script src="js/video_manager.js"></script>
    <script src="js/game.js"></script>
    <script src="js/animation.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/main.js"></script>

    <script>
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
        window.DEBUG_MODE = true;

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = document.getElementById('consoleOutput');

        function addConsoleMessage(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleMessage(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleMessage(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleMessage(args.join(' '), 'warning');
        };

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });

        // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
        function checkSystemStatus() {
            updateStatus('csvStatus', !!window.csvLoader);
            updateStatus('triggerStatus', !!window.triggerSystem);
            updateStatus('novelStatus', !!window.novelSystem);
            updateStatus('videoStatus', !!window.videoManager);
            updateStatus('mainStatus', !!window.gameMain);

            if (window.csvLoader && window.triggerSystem && window.novelSystem) {
                addConsoleMessage('âœ… å…¨ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
            } else {
                addConsoleMessage('âš  ä¸€éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãŒæœªåˆæœŸåŒ–', 'error');
            }
        }

        function updateStatus(elementId, isOk) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status-indicator ${isOk ? 'status-ok' : 'status-error'}`;
            }
        }

        // CSVãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆ
        async function testCSVLoader() {
            addConsoleMessage('CSVãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

            if (!window.csvLoader) {
                addConsoleMessage('CSVãƒ­ãƒ¼ãƒ€ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const files = ['story_full.csv', 'scene_triggers.csv'];
                const results = await window.csvLoader.preloadAllData(files);

                for (let file of files) {
                    if (results[file]) {
                        addConsoleMessage(`âœ… ${file}: ${results[file].length}è¡Œèª­ã¿è¾¼ã¿`, 'success');
                    } else {
                        addConsoleMessage(`âŒ ${file}: èª­ã¿è¾¼ã¿å¤±æ•—`, 'error');
                    }
                }
            } catch (error) {
                addConsoleMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function loadStoryData() {
            if (!window.csvLoader) {
                addConsoleMessage('CSVãƒ­ãƒ¼ãƒ€ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const data = await window.csvLoader.loadCSV('story_full.csv');
                addConsoleMessage(`ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿: ${data.length}è¡Œèª­ã¿è¾¼ã¿`, 'success');

                // æœ€åˆã®5è¡Œã‚’è¡¨ç¤º
                for (let i = 0; i < Math.min(5, data.length); i++) {
                    addConsoleMessage(`  ${data[i].scene_id}: ${data[i].text}`, 'info');
                }
            } catch (error) {
                addConsoleMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function loadTriggerData() {
            if (!window.csvLoader) {
                addConsoleMessage('CSVãƒ­ãƒ¼ãƒ€ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const data = await window.csvLoader.loadCSV('scene_triggers.csv');
                addConsoleMessage(`ãƒˆãƒªã‚¬ãƒ¼ãƒ‡ãƒ¼ã‚¿: ${data.length}è¡Œèª­ã¿è¾¼ã¿`, 'success');

                data.forEach(trigger => {
                    addConsoleMessage(`  ${trigger.trigger_id}: ${trigger.next_action}`, 'info');
                });
            } catch (error) {
                addConsoleMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function clearCSVCache() {
            if (window.csvLoader) {
                window.csvLoader.clearCache();
                addConsoleMessage('CSVã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        async function initTriggerSystem() {
            if (!window.triggerSystem) {
                addConsoleMessage('ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                await window.triggerSystem.initialize();
                addConsoleMessage('ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
            } catch (error) {
                addConsoleMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function testTriggerCheck() {
            if (!window.triggerSystem) {
                addConsoleMessage('ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const trigger = window.triggerSystem.checkTrigger('prologue', 9, '');
            if (trigger) {
                addConsoleMessage(`ãƒˆãƒªã‚¬ãƒ¼ç™ºè¦‹: ${trigger.trigger_id} -> ${trigger.next_action}`, 'success');
            } else {
                addConsoleMessage('è©²å½“ã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ãªã—', 'info');
            }
        }

        function debugTriggers() {
            if (window.triggerSystem) {
                window.triggerSystem.debugTriggers();
            }
        }

        // ãƒãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        async function testNovelSystem(scene) {
            if (!window.novelSystem) {
                addConsoleMessage('ãƒãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            addConsoleMessage(`ã‚·ãƒ¼ãƒ³ã€Œ${scene}ã€ã‚’é–‹å§‹`, 'info');
            await window.novelSystem.startScene(scene);
        }

        function debugNovelStatus() {
            if (window.novelSystem) {
                window.novelSystem.debugStatus();
            }
        }

        // ãƒ“ãƒ‡ã‚ªãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ
        function testVideo(videoId) {
            if (!window.videoManager) {
                addConsoleMessage('ãƒ“ãƒ‡ã‚ªãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            addConsoleMessage(`å‹•ç”»ã€Œ${videoId}ã€ã‚’å†ç”Ÿãƒ†ã‚¹ãƒˆ`, 'info');
            window.videoManager.playVideo(videoId);
        }

        function debugVideoStatus() {
            if (window.videoManager) {
                window.videoManager.debugStatus();
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        function testMainSystem() {
            if (window.debugMain) {
                window.debugMain();
            }
        }

        function testStartGame() {
            if (window.gameMain) {
                addConsoleMessage('æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ†ã‚¹ãƒˆ', 'info');
                // å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ç”»é¢ã«é·ç§»ã—ãªã„ã‚ˆã†ã€çŠ¶æ…‹ç¢ºèªã®ã¿
                addConsoleMessage(`ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³: ${window.gameMain.GameState.currentScene}`, 'info');
            }
        }

        function testSaveLoad() {
            if (window.gameMain) {
                window.gameMain.saveGame();
                addConsoleMessage('ã‚²ãƒ¼ãƒ ä¿å­˜ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

                window.gameMain.loadSaveData();
                addConsoleMessage('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            }
        }

        function resetGame() {
            if (window.resetGame) {
                window.resetGame();
            }
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
            addConsoleMessage('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢', 'info');
        }
    </script>
</body>
</html>